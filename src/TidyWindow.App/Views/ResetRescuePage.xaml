<Page x:Class="TidyWindow.App.Views.ResetRescuePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:controls="clr-namespace:TidyWindow.App.Views"
      mc:Ignorable="d"
      Title="Reset Rescue"
      Background="Transparent"
      FontFamily="Segoe UI Variable Text"
    TextOptions.TextFormattingMode="Ideal"
      TextOptions.TextRenderingMode="ClearType"
      TextOptions.TextHintingMode="Fixed"
      UseLayoutRounding="True"
      SnapsToDevicePixels="True">
    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <SolidColorBrush x:Key="ResetSurfaceBrush" Color="#060F1F"/>
        <LinearGradientBrush x:Key="ResetCardBackgroundBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#111F3A" Offset="0"/>
            <GradientStop Color="#0B1628" Offset="1"/>
        </LinearGradientBrush>
        <LinearGradientBrush x:Key="ResetCardBorderBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#1D3B67" Offset="0"/>
            <GradientStop Color="#123050" Offset="1"/>
        </LinearGradientBrush>
        <LinearGradientBrush x:Key="ResetPrimaryActionBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#5DF2BC" Offset="0"/>
            <GradientStop Color="#2ED4FF" Offset="1"/>
        </LinearGradientBrush>
        <LinearGradientBrush x:Key="ResetPrimaryActionHoverBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#58E396" Offset="0"/>
            <GradientStop Color="#1BB4FF" Offset="1"/>
        </LinearGradientBrush>
        <LinearGradientBrush x:Key="ResetSecondaryActionBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#1D335A" Offset="0"/>
            <GradientStop Color="#162540" Offset="1"/>
        </LinearGradientBrush>
        <LinearGradientBrush x:Key="ResetSecondaryActionHoverBrush" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#234070" Offset="0"/>
            <GradientStop Color="#1F3A63" Offset="1"/>
        </LinearGradientBrush>
        <SolidColorBrush x:Key="ResetMutedBrush" Color="#8CA3C8"/>
        <SolidColorBrush x:Key="ResetStrongBrush" Color="#E9F2FF"/>

        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource ResetCardBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource ResetCardBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="14"/>
            <Setter Property="Padding" Value="18"/>
            <Setter Property="Margin" Value="0,0,0,18"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#01060C" BlurRadius="18" ShadowDepth="0" Opacity="0.55"/>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="Foreground" Value="#041217"/>
            <Setter Property="Background" Value="{StaticResource ResetPrimaryActionBrush}"/>
            <Setter Property="Padding" Value="16,10"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Root" CornerRadius="10" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Root" Property="Background" Value="{StaticResource ResetPrimaryActionHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Root" Property="Background" Value="#103041"/>
                                <Setter Property="Foreground" Value="#5C708E"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButtonStyle" TargetType="Button" BasedOn="{StaticResource PrimaryButtonStyle}">
            <Setter Property="Foreground" Value="#E5EEFF"/>
            <Setter Property="Background" Value="{StaticResource ResetSecondaryActionBrush}"/>
            <Setter Property="BorderBrush" Value="#2B4A79"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="14,8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Root" CornerRadius="10" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Root" Property="Background" Value="{StaticResource ResetSecondaryActionHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Root" Property="Background" Value="#0E1728"/>
                                <Setter TargetName="Root" Property="BorderBrush" Value="#1E293B"/>
                                <Setter Property="Foreground" Value="#61708B"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="GhostButtonStyle" TargetType="Button" BasedOn="{StaticResource PrimaryButtonStyle}">
            <Setter Property="Foreground" Value="#B5C8E6"/>
            <Setter Property="Background" Value="#0E1728"/>
            <Setter Property="BorderBrush" Value="#20314D"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <Style x:Key="SecondaryToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Foreground" Value="#E5EEFF"/>
            <Setter Property="Background" Value="{StaticResource ResetSecondaryActionBrush}"/>
            <Setter Property="BorderBrush" Value="#2B4A79"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="14,8"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Root"
                                CornerRadius="10"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Root" Property="Background" Value="{StaticResource ResetSecondaryActionHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Root" Property="Background" Value="{StaticResource ResetPrimaryActionBrush}"/>
                                <Setter Property="Foreground" Value="#041217"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Root" Property="Background" Value="#0E1728"/>
                                <Setter TargetName="Root" Property="BorderBrush" Value="#1E293B"/>
                                <Setter Property="Foreground" Value="#61708B"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource ResetSurfaceBrush}" UseLayoutRounding="True" SnapsToDevicePixels="True">
        <Grid x:Name="ContentHost" UseLayoutRounding="True" SnapsToDevicePixels="True">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="IsHitTestVisible" Value="True"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsBusy}" Value="True">
                            <Setter Property="IsHitTestVisible" Value="False"/>
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0.35" Duration="0:0:0.25"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                            <DataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.25"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.ExitActions>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>

            <ScrollViewer Margin="32" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" CanContentScroll="True" PanningMode="VerticalOnly">
                <Grid MinWidth="760">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <controls:PageTitleBar Grid.Row="0"
                                            Title="Reset rescue"
                                            Subtitle="Back up user files and app data before a reset so you can restore with confidence."
                                            IconGlyph="ðŸ›Ÿ"
                                            Margin="0,0,0,22"/>

                    <Border Grid.Row="1" Style="{StaticResource CardStyle}" Padding="20,18">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="3*"/>
                                <ColumnDefinition Width="2*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Status" Foreground="{StaticResource ResetMutedBrush}" FontSize="12" Margin="0,0,0,6"/>
                                <TextBlock Text="{Binding Status}" Foreground="{StaticResource ResetStrongBrush}" FontSize="16" FontWeight="SemiBold" TextWrapping="Wrap" Margin="0,4,0,6"/>
                                <TextBlock Text="{Binding ProgressText}" Foreground="{StaticResource ResetMutedBrush}" FontSize="12" TextTrimming="CharacterEllipsis"/>
                                <TextBlock Text="{Binding ValidationSummary}" Foreground="#FCA5A5" TextWrapping="Wrap" Margin="0,6,0,0"/>
                                <TextBlock Text="{Binding CapacitySummary}" Foreground="#FBBF24" TextWrapping="Wrap" Margin="0,4,0,0"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="Last archive" Foreground="{StaticResource ResetMutedBrush}" FontSize="12" Margin="0,0,0,6"/>
                                <TextBlock Text="{Binding LastArchive}" Foreground="{StaticResource ResetStrongBrush}" TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <Border Grid.Row="2" Style="{StaticResource CardStyle}" Padding="14,12">
                        <DockPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" DockPanel.Dock="Left" VerticalAlignment="Center">
                                <ToggleButton Style="{StaticResource SecondaryToggleButtonStyle}" Content="Backup" IsChecked="{Binding IsBackupMode}" Command="{Binding SwitchToBackupCommand}" Margin="0,0,10,0" MinWidth="120"/>
                                <ToggleButton Style="{StaticResource SecondaryToggleButtonStyle}" Content="Restore" IsChecked="{Binding IsRestoreMode}" Command="{Binding SwitchToRestoreCommand}" Margin="0,0,10,0" MinWidth="120"/>
                                <Button Style="{StaticResource SecondaryButtonStyle}"
                                        Content="Info"
                                        Command="{Binding OpenInfoCommand}"
                                        Padding="14,8"
                                        MinWidth="96"/>
                            </StackPanel>
                            <TextBlock DockPanel.Dock="Right" Text="Choose a flow" Foreground="#8CA3C8" VerticalAlignment="Center" Margin="10,0,0,0"/>
                        </DockPanel>
                    </Border>

                    <StackPanel Grid.Row="3" Margin="0,0,0,12">
                        <!-- Backup inputs -->
                        <Border Style="{StaticResource CardStyle}" Padding="20,18" Visibility="{Binding IsBackupMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock Text="Backup destination" Foreground="{StaticResource ResetStrongBrush}" FontSize="15" FontWeight="SemiBold"/>
                                <DockPanel LastChildFill="True" VerticalAlignment="Center" Margin="0,6,0,6">
                                    <Button DockPanel.Dock="Right" Style="{StaticResource SecondaryButtonStyle}" Content="Browse" Click="OnBrowseDestination" IsEnabled="{Binding CanStart}" Margin="10,0,0,0"/>
                                    <TextBox MinWidth="320" Text="{Binding DestinationPath, UpdateSourceTrigger=PropertyChanged}" ToolTip="Archive output path"/>
                                </DockPanel>
                                <TextBlock Text="Pick where to save your .rrarchive. Refresh inventory to discover users and apps." Foreground="{StaticResource ResetMutedBrush}" FontSize="12" TextWrapping="Wrap"/>
                                <Button Style="{StaticResource GhostButtonStyle}" Content="Refresh inventory" Command="{Binding RefreshInventoryCommand}" IsEnabled="{Binding CanStart}" Width="160" Margin="0,8,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Restore inputs -->
                        <Border Style="{StaticResource CardStyle}" Padding="20,18" Visibility="{Binding IsRestoreMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock Text="Restore archive" Foreground="{StaticResource ResetStrongBrush}" FontSize="15" FontWeight="SemiBold"/>
                                <DockPanel LastChildFill="True" VerticalAlignment="Center" Margin="0,6,0,6">
                                    <Button DockPanel.Dock="Right" Style="{StaticResource SecondaryButtonStyle}" Content="Choose file" Click="OnBrowseArchive" IsEnabled="{Binding CanStart}" Margin="10,0,0,0"/>
                                    <TextBox MinWidth="320" Text="{Binding RestoreArchivePath, UpdateSourceTrigger=PropertyChanged}" ToolTip=".rrarchive path for restore"/>
                                </DockPanel>
                                <TextBlock Text="Restores go to original paths by default. Set a drive letter (e.g. D:\\) to redirect everything to another volume." Foreground="{StaticResource ResetMutedBrush}" FontSize="12" TextWrapping="Wrap"/>

                                <StackPanel Orientation="Horizontal" Margin="0,10,0,0" VerticalAlignment="Center">
                                    <TextBlock Text="Conflict handling" Foreground="{StaticResource ResetMutedBrush}" FontSize="12" Margin="0,0,8,0"/>
                                    <ComboBox Width="170" ItemsSource="{Binding ConflictStrategies}" SelectedItem="{Binding RestoreConflictStrategy, Mode=TwoWay}" IsEnabled="{Binding CanStart}">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>

                                <StackPanel Margin="0,12,0,0">
                                    <TextBlock Text="Volume override (optional)" Foreground="{StaticResource ResetStrongBrush}" FontSize="14" FontWeight="SemiBold"/>
                                    <TextBox Margin="0,6,0,4" Text="{Binding RestoreVolumeOverride, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" ToolTip="Set a drive or root folder to restore into (e.g. D:\\). Leave blank to use original locations."/>
                                </StackPanel>

                                <CheckBox Content="Restore HKCU registry (advanced)" IsChecked="{Binding RestoreRegistryEnabled}" Margin="0,12,0,0" Foreground="{StaticResource ResetMutedBrush}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <Border Grid.Row="4" Style="{StaticResource CardStyle}" Padding="22,20" Visibility="{Binding IsBackupMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="1.2*"/>
                                <ColumnDefinition Width="1.1*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Margin="0,0,18,0">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                                    <TextBlock Text="Apps" Foreground="{StaticResource ResetStrongBrush}" FontSize="15" FontWeight="SemiBold"/>
                                    <Ellipse Width="6" Height="6" Fill="#5DF2BC" Margin="8,4,0,0"/>
                                </StackPanel>
                                <Border Background="#0D1A30" BorderBrush="#1E2F49" BorderThickness="1" CornerRadius="12" Padding="12" SnapsToDevicePixels="True">
                                    <StackPanel>
                                        <TextBlock Text="Selected apps" Foreground="#8CA3C8" FontSize="12"/>
                                        <TextBlock Text="{Binding SelectedAppsPreview}" Foreground="{StaticResource ResetStrongBrush}" FontSize="14" FontWeight="SemiBold" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                        <TextBlock Text="{Binding SelectedAppCount, StringFormat={}{0} selected}" Foreground="#8CA3C8" FontSize="12" Margin="0,4,0,0"/>
                                        <Button Content="Select apps" Command="{Binding OpenAppPickerCommand}" Style="{StaticResource PrimaryButtonStyle}" Margin="0,10,0,0" Padding="12,6" HorizontalAlignment="Left"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <StackPanel Grid.Column="1">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,8">
                                    <TextBlock Text="User folders" Foreground="{StaticResource ResetStrongBrush}" FontSize="15" FontWeight="SemiBold"/>
                                    <Ellipse Width="6" Height="6" Fill="#5DF2BC" Margin="8,4,0,0"/>
                                </StackPanel>
                                <Border Background="#0D1A30" BorderBrush="#1E2F49" BorderThickness="1" CornerRadius="12" Padding="12" SnapsToDevicePixels="True">
                                    <StackPanel>
                                        <TextBlock Text="Selected folders" Foreground="#8CA3C8" FontSize="12"/>
                                        <TextBlock Text="{Binding SelectedFoldersPreview}" Foreground="{StaticResource ResetStrongBrush}" FontSize="14" FontWeight="SemiBold" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                        <TextBlock Text="{Binding SelectedFolderCount, StringFormat={}{0} selected}" Foreground="#8CA3C8" FontSize="12" Margin="0,4,0,0"/>
                                        <Button Content="Select folders" Command="{Binding OpenFolderPickerCommand}" Style="{StaticResource PrimaryButtonStyle}" Margin="0,10,0,0" Padding="12,6" HorizontalAlignment="Left"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <Border Grid.Row="5" Style="{StaticResource CardStyle}" Padding="16,14" Margin="0,0,0,0">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                            <StackPanel Orientation="Horizontal" Visibility="{Binding IsBackupMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Button Style="{StaticResource PrimaryButtonStyle}" Content="Start backup" Command="{Binding StartBackupCommand}" IsEnabled="{Binding CanStart}" Margin="0,0,12,0"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Visibility="{Binding IsRestoreMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Button Style="{StaticResource PrimaryButtonStyle}" Content="Start restore" Command="{Binding StartRestoreCommand}" IsEnabled="{Binding CanStart}" Margin="0,0,12,0"/>
                            </StackPanel>
                            <Button Style="{StaticResource GhostButtonStyle}" Content="Cancel" Command="{Binding CancelCommand}" IsEnabled="{Binding CanCancel}"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </ScrollViewer>
        </Grid>

        <Grid x:Name="AppsOverlay"
              Panel.ZIndex="8"
              Background="#B0020617"
              Visibility="{Binding IsAppPickerOpen, Converter={StaticResource BooleanToVisibilityConverter}}"
              IsHitTestVisible="{Binding IsAppPickerOpen}">
            <Border MaxWidth="980"
                    MaxHeight="720"
                    Margin="32"
                    Padding="26"
                    Background="#0B1729"
                    BorderBrush="#24344F"
                    BorderThickness="1"
                    CornerRadius="22"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <DockPanel Margin="0,0,0,14">
                        <StackPanel DockPanel.Dock="Left">
                            <TextBlock Text="Select apps" FontSize="20" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                            <TextBlock Text="Choose which app data to include in the backup." Foreground="#9FB0C7" FontSize="12" Margin="0,6,0,0"/>
                        </StackPanel>
                        <DockPanel DockPanel.Dock="Right" LastChildFill="False" VerticalAlignment="Center">
                            <Button DockPanel.Dock="Right" Content="Close" Command="{Binding CloseAppPickerCommand}" Style="{StaticResource SecondaryButtonStyle}" Padding="12,6" MinWidth="96" Margin="8,0,0,0"/>
                            <Border DockPanel.Dock="Right" Background="#0D1A30" BorderBrush="#1E2F49" BorderThickness="1" CornerRadius="8">
                                <TextBox Width="240"
                                         Height="32"
                                         Padding="10,4"
                                         BorderThickness="0"
                                         Background="Transparent"
                                         Foreground="#E9F2FF"
                                         CaretBrush="#5DF2BC"
                                         Text="{Binding AppSearch, UpdateSourceTrigger=PropertyChanged}"
                                         ToolTip="Search apps"
                                         VerticalContentAlignment="Center"/>
                            </Border>
                        </DockPanel>
                    </DockPanel>

                    <Border Grid.Row="1" Background="#0A162C" BorderBrush="#1E2F4B" BorderThickness="1" CornerRadius="12" Padding="12">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                            <ItemsControl ItemsSource="{Binding Apps}" SnapsToDevicePixels="True" UseLayoutRounding="True">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#0D1A30" BorderBrush="#1E2F49" BorderThickness="1" CornerRadius="10" Padding="14" Margin="0,0,0,10" SnapsToDevicePixels="True" Visibility="{Binding IsVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <StackPanel>
                                                <CheckBox Content="{Binding Display}" IsChecked="{Binding IsSelected, Mode=TwoWay}" Foreground="{StaticResource ResetStrongBrush}" FontWeight="SemiBold"/>
                                                <TextBlock Text="{Binding Type}" Foreground="#8CA3C8" FontSize="12" Margin="0,2,0,0"/>
                                                <ItemsControl ItemsSource="{Binding DataPaths}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <StackPanel />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Text="{Binding}" Foreground="#8CA3C8" FontSize="12" TextTrimming="CharacterEllipsis" Margin="0,2,0,0"/>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>

                    <Grid Grid.Row="2" Margin="0,14,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="{Binding SelectedAppCount, StringFormat={}{0} selected}" Foreground="#8CA3C8" VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Content="Clear" Command="{Binding ClearAppSelectionCommand}" Style="{StaticResource SecondaryButtonStyle}" Padding="12,6" MinWidth="100" Margin="0,0,10,0"/>
                        <Button Grid.Column="2" Content="Close" Command="{Binding CloseAppPickerCommand}" Style="{StaticResource PrimaryButtonStyle}" Padding="14,8" MinWidth="120"/>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <Grid x:Name="FoldersOverlay"
              Panel.ZIndex="8"
              Background="#B0020617"
              Visibility="{Binding IsFolderPickerOpen, Converter={StaticResource BooleanToVisibilityConverter}}"
              IsHitTestVisible="{Binding IsFolderPickerOpen}">
            <Border MaxWidth="980"
                    MaxHeight="720"
                    Margin="32"
                    Padding="26"
                    Background="#0B1729"
                    BorderBrush="#24344F"
                    BorderThickness="1"
                    CornerRadius="22"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <DockPanel Margin="0,0,0,14">
                        <StackPanel DockPanel.Dock="Left">
                            <TextBlock Text="Select user folders" FontSize="20" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                            <TextBlock Text="Pick which user directories to include in the backup." Foreground="#9FB0C7" FontSize="12" Margin="0,6,0,0"/>
                        </StackPanel>
                        <DockPanel DockPanel.Dock="Right" LastChildFill="False" VerticalAlignment="Center">
                            <Button DockPanel.Dock="Right" Content="Close" Command="{Binding CloseFolderPickerCommand}" Style="{StaticResource SecondaryButtonStyle}" Padding="12,6" MinWidth="96" Margin="8,0,0,0"/>
                        </DockPanel>
                    </DockPanel>

                    <Border Grid.Row="1" Background="#0A162C" BorderBrush="#1E2F4B" BorderThickness="1" CornerRadius="12" Padding="12">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                            <ItemsControl ItemsSource="{Binding Folders}" SnapsToDevicePixels="True" UseLayoutRounding="True">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#0D1A30" BorderBrush="#1E2F49" BorderThickness="1" CornerRadius="10" Padding="14" Margin="0,0,0,10" SnapsToDevicePixels="True">
                                            <StackPanel>
                                                <CheckBox Content="{Binding Display}" IsChecked="{Binding IsSelected, Mode=TwoWay}" Foreground="{StaticResource ResetStrongBrush}" FontWeight="SemiBold"/>
                                                <TextBlock Text="{Binding Owner}" Foreground="#8CA3C8" FontSize="12" Margin="0,2,0,0"/>
                                                <TextBlock Text="{Binding Path}" Foreground="#8CA3C8" FontSize="12" TextTrimming="CharacterEllipsis" Margin="0,2,0,0"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>

                    <Grid Grid.Row="2" Margin="0,14,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="{Binding SelectedFolderCount, StringFormat={}{0} selected}" Foreground="#8CA3C8" VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Content="Clear" Command="{Binding ClearFolderSelectionCommand}" Style="{StaticResource SecondaryButtonStyle}" Padding="12,6" MinWidth="100" Margin="0,0,10,0"/>
                        <Button Grid.Column="2" Content="Close" Command="{Binding CloseFolderPickerCommand}" Style="{StaticResource PrimaryButtonStyle}" Padding="14,8" MinWidth="120"/>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <Grid x:Name="ProgressOverlay"
              Panel.ZIndex="10"
              Background="#B0020617"
              Visibility="{Binding IsProgressPopupOpen, Converter={StaticResource BooleanToVisibilityConverter}}"
              IsHitTestVisible="{Binding IsProgressPopupOpen}">
                <Border MinWidth="480"
                    MaxWidth="720"
                    MaxHeight="420"
                    Margin="32"
                    Padding="24"
                    Background="#0B1729"
                    BorderBrush="#24344F"
                    BorderThickness="1"
                    CornerRadius="18"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel>
                    <TextBlock Text="{Binding ProgressTitle}" FontSize="18" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                    <TextBlock Text="Live progress and ETA" Foreground="#9FB0C7" FontSize="12" Margin="0,4,0,10"/>

                    <ProgressBar Height="12" Minimum="0" Maximum="1" Value="{Binding ProgressValue}" Background="#0A1222" Foreground="{StaticResource ResetPrimaryActionBrush}"/>
                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                        <TextBlock Text="{Binding ProgressPercentText}" Foreground="{StaticResource ResetStrongBrush}" FontWeight="SemiBold"/>
                        <TextBlock Text="  Â·  " Foreground="#8CA3C8"/>
                        <TextBlock Text="{Binding ProgressEta}" Foreground="#8CA3C8"/>
                        <TextBlock Text="  Â·  " Foreground="#8CA3C8"/>
                        <TextBlock Text="{Binding ProgressSize}" Foreground="#8CA3C8"/>
                    </StackPanel>

                    <TextBlock Text="{Binding ProgressCurrentPath}" Foreground="#E9F2FF" FontSize="12" TextWrapping="Wrap" Margin="0,10,0,0"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
                        <Button Content="Cancel" Command="{Binding CancelCommand}" Style="{StaticResource SecondaryButtonStyle}" Padding="12,6" MinWidth="120"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <Grid x:Name="InfoOverlay"
              Panel.ZIndex="9"
              Background="#B0020617"
              Visibility="{Binding IsInfoPopupOpen, Converter={StaticResource BooleanToVisibilityConverter}}"
              IsHitTestVisible="{Binding IsInfoPopupOpen}">
            <Border MaxWidth="920"
                    MaxHeight="680"
                    Margin="32"
                    Padding="24"
                    Background="#0B1729"
                    BorderBrush="#24344F"
                    BorderThickness="1"
                    CornerRadius="18"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <DockPanel Margin="0,0,0,12">
                        <StackPanel DockPanel.Dock="Left">
                            <TextBlock Text="Reset rescue guidance" FontSize="18" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                            <TextBlock Text="Know the right order and caveats before you restore." Foreground="#9FB0C7" FontSize="12" Margin="0,4,0,0"/>
                        </StackPanel>
                    </DockPanel>

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <StackPanel>
                            <StackPanel Margin="0,0,0,10">
                                <TextBlock Text="Restore order (very important)" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource ResetStrongBrush}"/>
                                <TextBlock Text="1) OS reset   2) Reinstall app   3) Restore app data   4) First launch. Never restore after first launch." TextWrapping="Wrap" Foreground="#C7D2E2" Margin="0,4,0,0"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,10">
                                <TextBlock Text="How app data works" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource ResetStrongBrush}"/>
                                <TextBlock Text="App code and data are separate. Reinstalling brings code back; your backup brings data back." TextWrapping="Wrap" Foreground="#C7D2E2" Margin="0,4,0,0"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,10">
                                <TextBlock Text="Key data locations" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource ResetStrongBrush}"/>
                                <StackPanel Margin="0,4,0,0">
                                    <TextBlock Text="AppData\Roaming  â€“ User settings (most important)" Foreground="#C7D2E2"/>
                                    <TextBlock Text="AppData\Local    â€“ Caches, databases" Foreground="#C7D2E2"/>
                                    <TextBlock Text="AppData\LocalLow â€“ Sandboxed apps" Foreground="#C7D2E2"/>
                                    <TextBlock Text="ProgramData      â€“ Shared app data" Foreground="#C7D2E2"/>
                                    <TextBlock Text="App folder itself â€“ Portable apps" Foreground="#C7D2E2"/>
                                    <TextBlock Text="Registry (HKCU)   â€“ Preferences, state" Foreground="#C7D2E2"/>
                                    <TextBlock Text="Reinstalling restores code, not these." Foreground="#8CA3C8" Margin="0,4,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,10">
                                <TextBlock Text="When backup = no data loss" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource ResetStrongBrush}"/>
                                <TextBlock Text="Portable apps: back up the folder, restore it, done." TextWrapping="Wrap" Foreground="#C7D2E2" Margin="0,4,0,0"/>
                                <TextBlock Text="Traditional Win32/MSI: back up AppData (Roaming/Local) and relevant HKCU\Software keys, reinstall, restore paths." TextWrapping="Wrap" Foreground="#C7D2E2" Margin="0,2,0,0"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,10">
                                <TextBlock Text="When data loss risk remains" FontSize="14" FontWeight="SemiBold" Foreground="{StaticResource ResetStrongBrush}"/>
                                <TextBlock Text="Store/UWP apps: data under AppData\Local\Packages tied to package SID; treat as best-effort." TextWrapping="Wrap" Foreground="#C7D2E2" Margin="0,4,0,0"/>
                                <TextBlock Text="Cloud-synced apps: if you sign in before restore, cloud may overwrite restored local data." TextWrapping="Wrap" Foreground="#C7D2E2" Margin="0,2,0,0"/>
                                <TextBlock Text="Apps using machine-bound encryption/DRM: files may restore but stay unreadable without the original machine key." TextWrapping="Wrap" Foreground="#C7D2E2" Margin="0,2,0,0"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>

                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
                        <Button Content="Got it" Command="{Binding CloseInfoCommand}" Style="{StaticResource PrimaryButtonStyle}" Padding="14,8" MinWidth="120"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>
