<Page x:Class="TidyWindow.App.Views.KnownProcessesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:behaviors="clr-namespace:TidyWindow.App.Behaviors"
    xmlns:controls="clr-namespace:TidyWindow.App.Views"
    xmlns:converters="clr-namespace:TidyWindow.App.Converters"
    xmlns:core="clr-namespace:TidyWindow.Core.Processes;assembly=TidyWindow.Core"
    xmlns:ux="clr-namespace:TidyWindow.App.Controls"
    xmlns:viewModels="clr-namespace:TidyWindow.App.ViewModels"
    mc:Ignorable="d"
    Title="Known Processes"
    Background="Transparent"
    UseLayoutRounding="True"
    SnapsToDevicePixels="True"
    TextOptions.TextFormattingMode="Display"
    TextOptions.TextRenderingMode="ClearType"
    TextOptions.TextHintingMode="Fixed"
    RenderOptions.BitmapScalingMode="NearestNeighbor"
    RenderOptions.ClearTypeHint="Enabled"
    behaviors:ScrollBubbleBehavior.IsEnabled="True">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:EnumEqualsConverter x:Key="EnumEqualsConverter" />
        <converters:SuspicionLevelToBrushConverter x:Key="SuspicionBrush" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- VIBRANT COLOR PALETTE                                          -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <SolidColorBrush x:Key="PageBg" Color="#050B14" />
        <SolidColorBrush x:Key="CardBg" Color="#0C1829" />
        <SolidColorBrush x:Key="CardBgHover" Color="#0E1D32" />
        <SolidColorBrush x:Key="CardBorder" Color="#1A2D47" />
        <SolidColorBrush x:Key="TextPrimary" Color="#F8FAFC" />
        <SolidColorBrush x:Key="TextSecondary" Color="#CBD5E1" />
        <SolidColorBrush x:Key="TextMuted" Color="#64748B" />

        <!-- Vibrant Accent Colors -->
        <SolidColorBrush x:Key="AccentCyan" Color="#22D3EE" />
        <SolidColorBrush x:Key="AccentBlue" Color="#3B82F6" />
        <SolidColorBrush x:Key="AccentPurple" Color="#A855F7" />
        <SolidColorBrush x:Key="AccentPink" Color="#EC4899" />
        <SolidColorBrush x:Key="AccentTeal" Color="#2DD4BF" />
        <SolidColorBrush x:Key="SuccessGreen" Color="#4ADE80" />
        <SolidColorBrush x:Key="WarningAmber" Color="#FBBF24" />
        <SolidColorBrush x:Key="DangerRed" Color="#F87171" />

        <!-- Icon Font -->
        <FontFamily x:Key="FluentIcons">Segoe Fluent Icons, Segoe MDL2 Assets</FontFamily>

        <!-- Gradient Brushes -->
        <LinearGradientBrush x:Key="HeroGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#0A1628" Offset="0" />
            <GradientStop Color="#0F2847" Offset="0.5" />
            <GradientStop Color="#0D3355" Offset="1" />
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="CyanGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#22D3EE" Offset="0" />
            <GradientStop Color="#06B6D4" Offset="1" />
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="PurpleGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#A855F7" Offset="0" />
            <GradientStop Color="#7C3AED" Offset="1" />
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="GreenGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#4ADE80" Offset="0" />
            <GradientStop Color="#22C55E" Offset="1" />
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="BlueGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#38BDF8" Offset="0" />
            <GradientStop Color="#2563EB" Offset="1" />
        </LinearGradientBrush>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- MODERN CARD STYLES                                              -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <Style x:Key="ModernCard" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource CardBg}" />
            <Setter Property="BorderBrush" Value="{StaticResource CardBorder}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="16" />
            <Setter Property="Padding" Value="20" />
            <Setter Property="SnapsToDevicePixels" Value="True" />
        </Style>

        <Style x:Key="ProcessCard" TargetType="Border" BasedOn="{StaticResource ModernCard}">
            <Setter Property="Margin" Value="0,0,0,16" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="#38BDF8" />
                    <Setter Property="Background" Value="#0E1D32" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ThreatCard" TargetType="Border" BasedOn="{StaticResource ModernCard}">
            <Setter Property="Margin" Value="0,0,0,16" />
            <Style.Triggers>
                <DataTrigger Binding="{Binding Level}" Value="{x:Static core:SuspicionLevel.Red}">
                    <Setter Property="Background" Value="#1C0A0F" />
                    <Setter Property="BorderBrush" Value="#F87171" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Level}" Value="{x:Static core:SuspicionLevel.Orange}">
                    <Setter Property="Background" Value="#1A150B" />
                    <Setter Property="BorderBrush" Value="#FB923C" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Level}" Value="{x:Static core:SuspicionLevel.Yellow}">
                    <Setter Property="Background" Value="#1A1A0B" />
                    <Setter Property="BorderBrush" Value="#FBBF24" />
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- VIBRANT BADGE STYLES                                           -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <Style x:Key="StatusBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="10,5" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <Style x:Key="AutoStopBadge" TargetType="Border" BasedOn="{StaticResource StatusBadge}">
            <Setter Property="Background" Value="#052E16" />
            <Setter Property="BorderBrush" Value="#4ADE80" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style x:Key="KeepBadge" TargetType="Border" BasedOn="{StaticResource StatusBadge}">
            <Setter Property="Background" Value="#172554" />
            <Setter Property="BorderBrush" Value="#60A5FA" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style x:Key="CautionBadge" TargetType="Border" BasedOn="{StaticResource StatusBadge}">
            <Setter Property="Background" Value="#422006" />
            <Setter Property="BorderBrush" Value="#FBBF24" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style x:Key="SourceBadge" TargetType="Border" BasedOn="{StaticResource StatusBadge}">
            <Setter Property="Background" Value="#1E1B4B" />
            <Setter Property="BorderBrush" Value="#A78BFA" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="8,4" />
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- MODERN BUTTON STYLES                                            -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <Style x:Key="BtnPrimary" TargetType="Button">
            <Setter Property="Foreground" Value="#0F172A" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" CornerRadius="10" Padding="{TemplateBinding Padding}">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="#22D3EE" Offset="0" />
                                    <GradientStop Color="#06B6D4" Offset="1" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background">
                                    <Setter.Value>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="#67E8F9" Offset="0" />
                                            <GradientStop Color="#22D3EE" Offset="1" />
                                        </LinearGradientBrush>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BtnSecondary" TargetType="Button">
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" CornerRadius="10" Padding="{TemplateBinding Padding}"
                                Background="#1E293B" BorderBrush="#334155" BorderThickness="1">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#334155" />
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#22D3EE" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BtnDanger" TargetType="Button">
            <Setter Property="Foreground" Value="#FEE2E2" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" CornerRadius="10" Padding="{TemplateBinding Padding}"
                                Background="#7F1D1D" BorderBrush="#F87171" BorderThickness="1">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#991B1B" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BtnSuccess" TargetType="Button">
            <Setter Property="Foreground" Value="#052E16" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" CornerRadius="10" Padding="{TemplateBinding Padding}">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="#4ADE80" Offset="0" />
                                    <GradientStop Color="#22C55E" Offset="1" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background">
                                    <Setter.Value>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="#86EFAC" Offset="0" />
                                            <GradientStop Color="#4ADE80" Offset="1" />
                                        </LinearGradientBrush>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BtnPurple" TargetType="Button">
            <Setter Property="Foreground" Value="#FFFFFF" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="16,10" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" CornerRadius="10" Padding="{TemplateBinding Padding}">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="#A855F7" Offset="0" />
                                    <GradientStop Color="#7C3AED" Offset="1" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background">
                                    <Setter.Value>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="#C084FC" Offset="0" />
                                            <GradientStop Color="#A855F7" Offset="1" />
                                        </LinearGradientBrush>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- TOGGLE SWITCH                                                   -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <Style x:Key="ToggleSwitch" TargetType="ToggleButton">
            <Setter Property="Width" Value="48" />
            <Setter Property="Height" Value="26" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Focusable" Value="False" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Grid>
                            <Border x:Name="Track" CornerRadius="13" Background="#1E293B" BorderBrush="#475569" BorderThickness="1" />
                            <Ellipse x:Name="Thumb" Width="20" Height="20" Fill="#94A3B8" HorizontalAlignment="Left" Margin="2,0,0,0" />
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Track" Property="Background">
                                    <Setter.Value>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="#22D3EE" Offset="0" />
                                            <GradientStop Color="#06B6D4" Offset="1" />
                                        </LinearGradientBrush>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="Track" Property="BorderBrush" Value="#67E8F9" />
                                <Setter TargetName="Thumb" Property="Fill" Value="#FFFFFF" />
                                <Setter TargetName="Thumb" Property="HorizontalAlignment" Value="Right" />
                                <Setter TargetName="Thumb" Property="Margin" Value="0,0,2,0" />
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Track" Property="BorderBrush" Value="#22D3EE" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Track" Property="Opacity" Value="0.4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid>
        <ScrollViewer x:Name="PageScrollViewer"
                      Margin="24"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      CanContentScroll="False">
            <Grid behaviors:ScrollBubbleBehavior.IsEnabled="True">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- ═══════════════════════════════════════════════════════════════ -->
                <!-- HERO HEADER                                                     -->
                <!-- ═══════════════════════════════════════════════════════════════ -->
                <controls:PageTitleBar Grid.Row="0"
                                       Title="Known Processes"
                                       Subtitle="Auto-stop recommendations cockpit"
                                       IconGlyph="&#xE9F5;"
                                       BadgeText="{Binding Categories.Count, StringFormat={}{0} groups}"
                                       Margin="0,0,0,20">
                    <controls:PageTitleBar.TrailingContent>
                        <Button Style="{StaticResource BtnPrimary}"
                                Command="{Binding RefreshCommand}"
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE72C;" FontFamily="{StaticResource FluentIcons}" FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center" />
                                <TextBlock Text="Refresh" FontWeight="SemiBold" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>
                    </controls:PageTitleBar.TrailingContent>
                    <controls:PageTitleBar.BodyContent>
                        <Border Style="{StaticResource ModernCard}" Padding="20" Margin="0,8,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <TextBlock Text="Keep Windows services tidy with questionnaire-driven auto-stop recommendations."
                                               FontSize="14" Foreground="{StaticResource TextSecondary}" TextWrapping="Wrap" />
                                    <TextBlock Text="Lean on curated cues to quiet Xbox, Game Bar, and background helpers when idle."
                                               FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,8,0,0" TextWrapping="Wrap" />
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="20,0,0,0">
                                    <Border Style="{StaticResource AutoStopBadge}" Margin="0,0,10,0">
                                        <TextBlock Text="{Binding Summary}" FontSize="12" FontWeight="SemiBold" Foreground="#4ADE80" />
                                    </Border>
                                    <Border Style="{StaticResource SourceBadge}">
                                        <TextBlock Text="{Binding Categories.Count, StringFormat={}{0} groups}" FontSize="12" Foreground="#A78BFA" />
                                    </Border>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </controls:PageTitleBar.BodyContent>
                </controls:PageTitleBar>

                <!-- Loading Indicator -->
                <Border Grid.Row="1" Padding="16" Margin="0,0,0,16">
                    <Border.Style>
                        <Style TargetType="Border" BasedOn="{StaticResource ModernCard}">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsBusy}" Value="True" />
                                        <Condition Binding="{Binding ActiveSection}" Value="{x:Static viewModels:KnownProcessViewSection.Catalog}" />
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible" />
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <StackPanel Orientation="Horizontal">
                        <ProgressBar Width="160" Height="6" IsIndeterminate="True" Foreground="#22D3EE" Background="#1E293B" />
                        <TextBlock Margin="16,0,0,0" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center">
                            <Run Text="&#xE721;" FontFamily="{StaticResource FluentIcons}" /><Run Text=" Loading known processes..." />
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- ═══════════════════════════════════════════════════════════════ -->
                <!-- MAIN CONTENT AREA                                               -->
                <!-- ═══════════════════════════════════════════════════════════════ -->
                <Grid Grid.Row="2">

                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <!-- CATALOG VIEW                                                -->
                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <Grid>
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ActiveSection}" Value="{x:Static viewModels:KnownProcessViewSection.Catalog}">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>

                        <!-- Process Cards List -->
                        <ItemsControl ItemsSource="{Binding Categories}"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling"
                                      VirtualizingPanel.ScrollUnit="Pixel">
                            <ItemsControl.Style>
                                <Style TargetType="ItemsControl">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasProcesses}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ItemsControl.Style>
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <VirtualizingStackPanel />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <!-- Category Section -->
                                    <Border Style="{StaticResource ModernCard}" Margin="0,0,0,20">
                                        <StackPanel>
                                            <!-- Category Header -->
                                            <Grid Margin="0,0,0,16">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <!-- Category Icon -->
                                                <Border Width="44" Height="44" CornerRadius="12" Margin="0,0,16,0">
                                                    <Border.Background>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                            <GradientStop Color="#1E3A8A" Offset="0" />
                                                            <GradientStop Color="#3730A3" Offset="1" />
                                                        </LinearGradientBrush>
                                                    </Border.Background>
                                                    <TextBlock Text="&#xE74C;" FontFamily="{StaticResource FluentIcons}" FontSize="18" Foreground="#A78BFA" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                </Border>

                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding Name}" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" />
                                                        <Border Style="{StaticResource CautionBadge}" Margin="12,0,0,0"
                                                                Visibility="{Binding IsCaution, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="&#xE7BA;" FontFamily="{StaticResource FluentIcons}" FontSize="11" Foreground="#FBBF24" VerticalAlignment="Center" />
                                                                <TextBlock Text=" Caution" FontSize="11" FontWeight="SemiBold" Foreground="#FBBF24" VerticalAlignment="Center" />
                                                            </StackPanel>
                                                        </Border>
                                                    </StackPanel>
                                                    <TextBlock Text="{Binding Description}" FontSize="13" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" TextWrapping="Wrap" />
                                                </StackPanel>

                                                <Border Grid.Column="2" Style="{StaticResource SourceBadge}">
                                                    <TextBlock Text="{Binding Processes.Count, StringFormat={}{0} items}" FontSize="12" Foreground="#A78BFA" />
                                                </Border>
                                            </Grid>

                                            <!-- Process Items Grid -->
                                            <ItemsControl ItemsSource="{Binding Processes}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <ux:AdaptiveTilePanel MinColumnWidth="340" MaxColumnWidth="560"
                                                                              MinColumns="1" MaxColumns="3"
                                                                              ColumnSpacing="16" RowSpacing="16" />
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Style="{StaticResource ProcessCard}" Margin="0">
                                                            <StackPanel>
                                                                <!-- Process Header -->
                                                                <Grid Margin="0,0,0,12">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto" />
                                                                        <ColumnDefinition Width="*" />
                                                                        <ColumnDefinition Width="Auto" />
                                                                    </Grid.ColumnDefinitions>

                                                                    <!-- Status Icon -->
                                                                    <Border Width="36" Height="36" CornerRadius="10" Margin="0,0,12,0">
                                                                        <Border.Style>
                                                                            <Style TargetType="Border">
                                                                                <Setter Property="Background">
                                                                                    <Setter.Value>
                                                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                                            <GradientStop Color="#172554" Offset="0" />
                                                                                            <GradientStop Color="#1E3A8A" Offset="1" />
                                                                                        </LinearGradientBrush>
                                                                                    </Setter.Value>
                                                                                </Setter>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding IsAutoStop}" Value="True">
                                                                                        <Setter Property="Background">
                                                                                            <Setter.Value>
                                                                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                                                    <GradientStop Color="#052E16" Offset="0" />
                                                                                                    <GradientStop Color="#14532D" Offset="1" />
                                                                                                </LinearGradientBrush>
                                                                                            </Setter.Value>
                                                                                        </Setter>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </Border.Style>
                                                                        <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" FontFamily="{StaticResource FluentIcons}" FontSize="16">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="Text" Value="&#xEA3A;" />
                                                                                    <Setter Property="Foreground" Value="#60A5FA" />
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding IsAutoStop}" Value="True">
                                                                                            <Setter Property="Text" Value="&#xE73E;" />
                                                                                            <Setter Property="Foreground" Value="#4ADE80" />
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                    </Border>

                                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="{Binding DisplayName}" FontSize="15" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" />
                                                                            <Border Style="{StaticResource CautionBadge}" Padding="6,2" Margin="8,0,0,0"
                                                                                    Visibility="{Binding IsCaution, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                                                <TextBlock Text="&#xE7BA;" FontFamily="{StaticResource FluentIcons}" FontSize="10" Foreground="#FBBF24" />
                                                                            </Border>
                                                                        </StackPanel>
                                                                        <TextBlock Text="{Binding RecommendationLabel}" FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,2,0,0" />
                                                                    </StackPanel>

                                                                    <Border Grid.Column="2" Style="{StaticResource SourceBadge}">
                                                                        <TextBlock Text="{Binding SourceLabel}" FontSize="10" Foreground="#C4B5FD" />
                                                                    </Border>
                                                                </Grid>

                                                                <!-- Rationale -->
                                                                <TextBlock Text="{Binding Rationale}" FontSize="13" Foreground="{StaticResource TextSecondary}"
                                                                           TextWrapping="Wrap" Margin="0,0,0,12" LineHeight="20" />

                                                                <!-- Status Row -->
                                                                <Grid Margin="0,0,0,14">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto" />
                                                                        <ColumnDefinition Width="*" />
                                                                    </Grid.ColumnDefinitions>
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <TextBlock Text="Status:" FontSize="12" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center" />
                                                                        <Border Margin="8,0,0,0" CornerRadius="6" Padding="8,4">
                                                                            <Border.Style>
                                                                                <Style TargetType="Border">
                                                                                    <Setter Property="Background" Value="#172554" />
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding IsAutoStop}" Value="True">
                                                                                            <Setter Property="Background" Value="#052E16" />
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </Border.Style>
                                                                            <TextBlock Text="{Binding ActionLabel}" FontSize="12" FontWeight="SemiBold">
                                                                                <TextBlock.Style>
                                                                                    <Style TargetType="TextBlock">
                                                                                        <Setter Property="Foreground" Value="#60A5FA" />
                                                                                        <Style.Triggers>
                                                                                            <DataTrigger Binding="{Binding IsAutoStop}" Value="True">
                                                                                                <Setter Property="Foreground" Value="#4ADE80" />
                                                                                            </DataTrigger>
                                                                                        </Style.Triggers>
                                                                                    </Style>
                                                                                </TextBlock.Style>
                                                                            </TextBlock>
                                                                        </Border>
                                                                    </StackPanel>
                                                                </Grid>

                                                                <!-- Action Buttons -->
                                                                <WrapPanel>
                                                                    <Button Style="{StaticResource BtnSuccess}" Margin="0,0,8,8" Command="{Binding ToggleActionCommand}">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="&#xE8AB;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                                            <TextBlock Text="{Binding ToggleActionLabel}" VerticalAlignment="Center" />
                                                                        </StackPanel>
                                                                    </Button>
                                                                    <Button Style="{StaticResource BtnDanger}" Margin="0,0,8,8" Command="{Binding StopCommand}" IsEnabled="{Binding CanControl}">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="&#xE71A;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                                            <TextBlock Text="Stop" VerticalAlignment="Center" />
                                                                        </StackPanel>
                                                                    </Button>
                                                                    <Button Style="{StaticResource BtnSecondary}" Margin="0,0,8,8" Command="{Binding RestartCommand}" IsEnabled="{Binding CanControl}">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="&#xE72C;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                                            <TextBlock Text="Restart" VerticalAlignment="Center" />
                                                                        </StackPanel>
                                                                    </Button>
                                                                    <Button Style="{StaticResource BtnSecondary}" Margin="0,0,0,8" Command="{Binding LearnMoreCommand}">
                                                                        <StackPanel Orientation="Horizontal">
                                                                            <TextBlock Text="&#xE736;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                                            <TextBlock Text="Learn" VerticalAlignment="Center" />
                                                                        </StackPanel>
                                                                    </Button>
                                                                </WrapPanel>

                                                                <!-- Feedback Message -->
                                                                <TextBlock Text="{Binding LastActionMessage}" FontSize="12" Foreground="#FBBF24" Margin="0,4,0,0" TextWrapping="Wrap">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding LastActionMessage}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding LastActionMessage}" Value="">
                                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Empty State -->
                        <Border Padding="40" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Border.Style>
                                <Style TargetType="Border" BasedOn="{StaticResource ModernCard}">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding HasProcesses}" Value="False" />
                                                <Condition Binding="{Binding IsBusy}" Value="False" />
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible" />
                                        </MultiDataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <StackPanel HorizontalAlignment="Center">
                                <Border Width="80" Height="80" CornerRadius="20" HorizontalAlignment="Center" Margin="0,0,0,20">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                            <GradientStop Color="#1E3A8A" Offset="0" />
                                            <GradientStop Color="#3730A3" Offset="1" />
                                        </LinearGradientBrush>
                                    </Border.Background>
                                    <TextBlock Text="&#xE8B7;" FontFamily="{StaticResource FluentIcons}" FontSize="36" Foreground="#A78BFA" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                </Border>
                                <TextBlock Text="No known processes yet" FontSize="20" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" HorizontalAlignment="Center" />
                                <TextBlock Text="Run the questionnaire or refresh to populate this tab." FontSize="14" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Center" Margin="0,8,0,0" />
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <!-- SETTINGS VIEW                                               -->
                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" DataContext="{Binding Preferences}">
                        <ScrollViewer.Style>
                            <Style TargetType="ScrollViewer">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DataContext.ActiveSection, RelativeSource={RelativeSource AncestorType=Grid}}"
                                                 Value="{x:Static viewModels:KnownProcessViewSection.Settings}">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ScrollViewer.Style>
                        <StackPanel>
                            <!-- Automation Controls Card -->
                            <Border Style="{StaticResource ModernCard}" Margin="0,0,0,20">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                        <Border Width="44" Height="44" CornerRadius="12" Margin="0,0,16,0">
                                            <Border.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                    <GradientStop Color="#7C3AED" Offset="0" />
                                                    <GradientStop Color="#5B21B6" Offset="1" />
                                                </LinearGradientBrush>
                                            </Border.Background>
                                            <TextBlock Text="&#xE713;" FontFamily="{StaticResource FluentIcons}" FontSize="18" Foreground="#C4B5FD" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                        </Border>
                                        <StackPanel VerticalAlignment="Center">
                                            <TextBlock Text="Process Automation Controls" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" />
                                            <TextBlock Text="Quick access to questionnaire guidance and key adjustments." FontSize="13" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" />
                                        </StackPanel>
                                    </StackPanel>

                                    <Border Background="#0F172A" CornerRadius="12" Padding="16" Margin="0,0,0,16">
                                        <StackPanel>
                                            <TextBlock Text="{Binding ProcessSummary}" FontSize="14" FontWeight="SemiBold" Foreground="#22D3EE" />
                                            <TextBlock Text="{Binding AutoStopSummary}" FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,6,0,0" />
                                            <TextBlock Text="{Binding QuestionnaireSummary}" FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" />
                                        </StackPanel>
                                    </Border>

                                    <WrapPanel>
                                        <Button Style="{StaticResource BtnSecondary}" Margin="0,0,10,10" Command="{Binding RefreshProcessPreferencesCommand}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE72C;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Refresh" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                        <Button Style="{StaticResource BtnPrimary}" Margin="0,0,10,10" Command="{Binding RerunQuestionnaireCommand}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE762;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Rerun Questionnaire" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                        <Button Style="{StaticResource BtnDanger}" Margin="0,0,10,10" Command="{Binding ResetProcessPreferencesCommand}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE777;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Reset to Recommended" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                        <Button Style="{StaticResource BtnPurple}" Margin="0,0,0,10" Command="{Binding ShowThreatWatchHoldingsCommand}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE83D;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Manage Allow &amp; Quarantine" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                    </WrapPanel>
                                </StackPanel>
                            </Border>

                            <!-- Auto-stop Enforcement Card -->
                            <Border Style="{StaticResource ModernCard}" Margin="0,0,0,20">
                                <StackPanel>
                                    <Grid Margin="0,0,0,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <Border Width="44" Height="44" CornerRadius="12" Margin="0,0,16,0">
                                            <Border.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                    <GradientStop Color="#059669" Offset="0" />
                                                    <GradientStop Color="#047857" Offset="1" />
                                                </LinearGradientBrush>
                                            </Border.Background>
                                            <TextBlock Text="&#xE9D5;" FontFamily="{StaticResource FluentIcons}" FontSize="18" Foreground="#4ADE80" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                        </Border>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="Background Auto-stop Enforcement" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" />
                                            <TextBlock Text="Periodically re-stop services to keep telemetry quiet." FontSize="13" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" />
                                        </StackPanel>
                                        <ToggleButton Grid.Column="2" Style="{StaticResource ToggleSwitch}" IsChecked="{Binding IsAutoStopAutomationEnabled, Mode=TwoWay}" VerticalAlignment="Center" />
                                    </Grid>

                                    <Border Background="#0F172A" CornerRadius="12" Padding="16" Margin="0,0,0,16">
                                        <StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                                <TextBlock VerticalAlignment="Center" FontSize="13" Foreground="{StaticResource TextSecondary}">
                                                    <Run Text="&#xE916;" FontFamily="{StaticResource FluentIcons}" /><Run Text=" Interval:" />
                                                </TextBlock>
                                                <ComboBox Width="130" Margin="12,0,0,0"
                                                          ItemsSource="{Binding AutoStopIntervalOptions}"
                                                          SelectedItem="{Binding AutoStopIntervalMinutes, Mode=TwoWay}">
                                                    <ComboBox.ItemTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Text="{Binding StringFormat={}{0} min}" />
                                                        </DataTemplate>
                                                    </ComboBox.ItemTemplate>
                                                </ComboBox>
                                            </StackPanel>
                                            <TextBlock Text="{Binding AutoStopStatusMessage}" FontSize="12" Foreground="{StaticResource TextMuted}" />
                                        </StackPanel>
                                    </Border>

                                    <Border Style="{StaticResource CautionBadge}" HorizontalAlignment="Left" Margin="0,0,0,16"
                                            Visibility="{Binding HasAutomationChanges, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock FontSize="12" Foreground="#FBBF24">
                                            <Run Text="&#xE945;" FontFamily="{StaticResource FluentIcons}" /><Run Text=" Pending changes — apply to activate" />
                                        </TextBlock>
                                    </Border>

                                    <WrapPanel>
                                        <Button Style="{StaticResource BtnSuccess}" Margin="0,0,10,0" Command="{Binding ApplyAutoStopAutomationCommand}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE73E;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Apply &amp; Enforce" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                        <Button Style="{StaticResource BtnSecondary}" Command="{Binding RunAutoStopNowCommand}" IsEnabled="{Binding IsAutoStopAutomationEnabled}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE768;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Run Now" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                    </WrapPanel>
                                </StackPanel>
                            </Border>

                            <!-- Loading Preferences -->
                            <Border Padding="16" Margin="0,0,0,20" Visibility="{Binding IsProcessSettingsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource ModernCard}" />
                                </Border.Style>
                                <StackPanel Orientation="Horizontal">
                                    <ProgressBar Width="140" Height="6" IsIndeterminate="True" Foreground="#22D3EE" Background="#1E293B" />
                                    <TextBlock Text="Loading preferences..." FontSize="13" Foreground="{StaticResource TextMuted}" Margin="16,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </Border>

                            <!-- Segment Quick Toggles Card -->
                            <Border Style="{StaticResource ModernCard}">
                                <StackPanel>
                                    <Grid Margin="0,0,0,16">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <Border Width="44" Height="44" CornerRadius="12" Margin="0,0,16,0">
                                            <Border.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                    <GradientStop Color="#0891B2" Offset="0" />
                                                    <GradientStop Color="#0E7490" Offset="1" />
                                                </LinearGradientBrush>
                                            </Border.Background>
                                            <TextBlock Text="&#xE9E9;" FontFamily="{StaticResource FluentIcons}" FontSize="18" Foreground="#22D3EE" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                        </Border>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="Segment Quick Toggles" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" />
                                            <TextBlock Text="{Binding SegmentSummary}" FontSize="13" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" />
                                        </StackPanel>
                                        <Border Grid.Column="2" Style="{StaticResource SourceBadge}">
                                            <TextBlock Text="{Binding Segments.Count, StringFormat={}{0} segments}" FontSize="12" Foreground="#A78BFA" />
                                        </Border>
                                    </Grid>

                                    <ItemsControl ItemsSource="{Binding Segments}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <ux:AdaptiveTilePanel MinColumnWidth="280" MaxColumnWidth="440"
                                                                      MinColumns="1" MaxColumns="3"
                                                                      ColumnSpacing="16" RowSpacing="16" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="{x:Type viewModels:ProcessPreferenceSegmentViewModel}">
                                                <Border Style="{StaticResource ProcessCard}" Margin="0" Padding="16">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>
                                                        <StackPanel>
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="{Binding Title}" FontSize="15" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" />
                                                                <Border Style="{StaticResource CautionBadge}" Padding="6,2" Margin="8,0,0,0"
                                                                        Visibility="{Binding IsCaution, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                                    <TextBlock Text="&#xE7BA;" FontFamily="{StaticResource FluentIcons}" FontSize="10" Foreground="#FBBF24" />
                                                                </Border>
                                                            </StackPanel>
                                                            <TextBlock Text="{Binding Description}" FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" TextWrapping="Wrap">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Description}" Value="{x:Null}">
                                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding Description}" Value="">
                                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <TextBlock Text="{Binding Summary}" FontSize="13" Foreground="{StaticResource TextSecondary}" Margin="0,8,0,0" />
                                                        </StackPanel>
                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Right">
                                                            <ToggleButton Style="{StaticResource ToggleSwitch}"
                                                                          IsChecked="{Binding SegmentToggleValue, Mode=TwoWay}"
                                                                          IsEnabled="{Binding HasProcesses}" />
                                                            <TextBlock Text="{Binding StateLabel}" FontSize="11" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Right" Margin="0,6,0,0" />
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <TextBlock Text="Process segments appear when known processes load." FontSize="13" Foreground="{StaticResource TextMuted}" Margin="0,16,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasSegments}" Value="False">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <!-- THREAT WATCH VIEW                                           -->
                    <!-- ═══════════════════════════════════════════════════════════ -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" DataContext="{Binding ThreatWatch}">
                        <ScrollViewer.Style>
                            <Style TargetType="ScrollViewer">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DataContext.ActiveSection, RelativeSource={RelativeSource AncestorType=Grid}}"
                                                 Value="{x:Static viewModels:KnownProcessViewSection.ThreatWatch}">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ScrollViewer.Style>
                        <StackPanel>
                            <!-- Threat Watch Title -->
                            <controls:PageTitleBar Title="Threat Watch"
                                                   Subtitle="Surface and quarantine suspicious activity"
                                                   IconGlyph="&#xE83D;"
                                                   Margin="0,0,0,20" />

                            <!-- Status Card -->
                            <Border Style="{StaticResource ModernCard}" Margin="0,0,0,20">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Border Width="56" Height="56" CornerRadius="14" Margin="0,0,20,0">
                                        <Border.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                <GradientStop Color="#DC2626" Offset="0" />
                                                <GradientStop Color="#B91C1C" Offset="1" />
                                            </LinearGradientBrush>
                                        </Border.Background>
                                        <TextBlock Text="&#xE83D;" FontFamily="{StaticResource FluentIcons}" FontSize="24" Foreground="#FEE2E2" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                    </Border>
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="Status" FontSize="12" Foreground="{StaticResource TextMuted}" />
                                        <TextBlock Text="{Binding Summary}" FontSize="20" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" Margin="0,4,0,0" />
                                        <TextBlock Text="{Binding LastScanSummary}" FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,4,0,0" />
                                    </StackPanel>
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Button Style="{StaticResource BtnPrimary}" Margin="0,0,10,0" Command="{Binding RefreshCommand}"
                                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE721;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Scan Now" FontWeight="SemiBold" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                        <Button Style="{StaticResource BtnSecondary}" Command="{Binding RefreshCommand}"
                                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#xE72C;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBlock Text="Refresh" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <!-- Filters -->
                            <Grid Margin="0,0,0,20">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <StackPanel Orientation="Horizontal">
                                    <TextBox Width="260" Margin="0,0,12,0" Style="{StaticResource App.TextBoxStyle}"
                                             Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" />
                                    <ComboBox Width="180" Style="{StaticResource App.ComboBoxStyle}"
                                              SelectedValue="{Binding FilterLevel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              SelectedValuePath="Tag">
                                        <ComboBoxItem Content="All severities" Tag="{x:Null}" />
                                        <ComboBoxItem Content="Critical" Tag="{x:Static core:SuspicionLevel.Red}" />
                                        <ComboBoxItem Content="Elevated" Tag="{x:Static core:SuspicionLevel.Orange}" />
                                        <ComboBoxItem Content="Watch" Tag="{x:Static core:SuspicionLevel.Yellow}" />
                                    </ComboBox>
                                </StackPanel>
                                <Button Grid.Column="1" Content="Clear Filters" Style="{StaticResource BtnSecondary}" Command="{Binding ClearFiltersCommand}" />
                            </Grid>

                            <!-- Hits List -->
                            <ItemsControl ItemsSource="{Binding HitsView}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Style="{StaticResource ThreatCard}">
                                            <StackPanel>
                                                <!-- Header -->
                                                <Grid Margin="0,0,0,12">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding ProcessName}" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" />
                                                        <Border CornerRadius="8" Padding="10,4" Margin="12,0,0,0"
                                                                Background="{Binding Level, Converter={StaticResource SuspicionBrush}}">
                                                            <TextBlock Text="{Binding SeverityLabel}" FontSize="11" FontWeight="Bold" Foreground="#0F172A" />
                                                        </Border>
                                                    </StackPanel>
                                                    <TextBlock Grid.Column="1" FontSize="12" Foreground="{StaticResource TextMuted}" VerticalAlignment="Center">
                                                        <Run Text="&#xE823;" FontFamily="{StaticResource FluentIcons}" /><Run Text=" " /><Run Text="{Binding ObservedAt}" />
                                                    </TextBlock>
                                                </Grid>

                                                <!-- Path -->
                                                <TextBlock Text="{Binding FilePath}" FontSize="13" Foreground="{StaticResource TextSecondary}" TextWrapping="Wrap" Margin="0,0,0,12" />

                                                <!-- Source -->
                                                <Border Style="{StaticResource SourceBadge}" HorizontalAlignment="Left" Margin="0,0,0,12">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock FontSize="11" Foreground="{StaticResource TextMuted}">
                                                            <Run Text="&#xE707;" FontFamily="{StaticResource FluentIcons}" /><Run Text=" Source:" />
                                                        </TextBlock>
                                                        <TextBlock Text="{Binding Source}" FontSize="12" Foreground="{StaticResource TextPrimary}" Margin="6,0,0,0" />
                                                    </StackPanel>
                                                </Border>

                                                <!-- Rules -->
                                                <ItemsControl ItemsSource="{Binding MatchedRules}" Margin="0,0,0,12"
                                                              Visibility="{Binding HasRules, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border CornerRadius="6" Padding="8,4" Margin="0,0,8,6">
                                                                <Border.Background>
                                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                        <GradientStop Color="#1E3A8A" Offset="0" />
                                                                        <GradientStop Color="#3730A3" Offset="1" />
                                                                    </LinearGradientBrush>
                                                                </Border.Background>
                                                                <TextBlock Text="{Binding}" FontSize="11" FontWeight="SemiBold" Foreground="#C4B5FD" />
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>

                                                <TextBlock Text="No rule signatures flagged." FontStyle="Italic" FontSize="12" Foreground="{StaticResource TextMuted}" Margin="0,0,0,12">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding HasRules}" Value="False">
                                                                    <Setter Property="Visibility" Value="Visible" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>

                                                <!-- Actions -->
                                                <WrapPanel HorizontalAlignment="Right">
                                                    <Button Style="{StaticResource BtnSuccess}" Margin="0,0,8,0" Command="{Binding WhitelistCommand}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="&#xE73E;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                            <TextBlock Text="Whitelist" VerticalAlignment="Center" />
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource BtnPurple}" Margin="0,0,8,0" Command="{Binding ScanFileCommand}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="&#xE721;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                            <TextBlock Text="Scan File" VerticalAlignment="Center" />
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource BtnPrimary}" Margin="0,0,8,0" Command="{Binding OpenLocationCommand}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="&#xE838;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                            <TextBlock Text="Open Location" VerticalAlignment="Center" />
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource BtnSecondary}" Margin="0,0,8,0" Command="{Binding IgnoreCommand}">
                                                        <TextBlock Text="Ignore" VerticalAlignment="Center" />
                                                    </Button>
                                                    <Button Style="{StaticResource BtnDanger}" Command="{Binding QuarantineCommand}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="&#xE8F8;" FontFamily="{StaticResource FluentIcons}" FontSize="12" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                            <TextBlock Text="Quarantine" VerticalAlignment="Center" />
                                                        </StackPanel>
                                                    </Button>
                                                </WrapPanel>

                                                <!-- Feedback -->
                                                <TextBlock Text="{Binding LastActionMessage}" FontSize="12" Foreground="#FBBF24" Margin="0,10,0,0" TextWrapping="Wrap">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding LastActionMessage}" Value="">
                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding LastActionMessage}" Value="{x:Null}">
                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Empty State -->
                            <Border Padding="40" HorizontalAlignment="Stretch">
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource ModernCard}">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HitsView.IsEmpty}" Value="True">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <StackPanel HorizontalAlignment="Center">
                                    <Border Width="80" Height="80" CornerRadius="20" HorizontalAlignment="Center" Margin="0,0,0,20">
                                        <Border.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                <GradientStop Color="#052E16" Offset="0" />
                                                <GradientStop Color="#14532D" Offset="1" />
                                            </LinearGradientBrush>
                                        </Border.Background>
                                        <TextBlock Text="&#xE73E;" FontFamily="{StaticResource FluentIcons}" FontSize="36" Foreground="#4ADE80" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                    </Border>
                                    <TextBlock Text="All Clear!" FontSize="20" FontWeight="SemiBold" Foreground="{StaticResource SuccessGreen}" HorizontalAlignment="Center" />
                                    <TextBlock Text="No suspicious processes match current filters." FontSize="14" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Center" Margin="0,8,0,0" />
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Grid>
        </ScrollViewer>

        <!-- ═══════════════════════════════════════════════════════════════ -->
        <!-- GLOBAL BUSY OVERLAY                                             -->
        <!-- ═══════════════════════════════════════════════════════════════ -->
        <Grid Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
              Background="#E6050B14" Panel.ZIndex="20">
            <Border HorizontalAlignment="Center" VerticalAlignment="Center" Padding="32" CornerRadius="20">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#0C1829" Offset="0" />
                        <GradientStop Color="#1E293B" Offset="1" />
                    </LinearGradientBrush>
                </Border.Background>
                <Border.BorderBrush>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#22D3EE" Offset="0" />
                        <GradientStop Color="#7C3AED" Offset="1" />
                    </LinearGradientBrush>
                </Border.BorderBrush>
                <Border.BorderThickness>1</Border.BorderThickness>
                <StackPanel HorizontalAlignment="Center">
                    <ProgressBar Width="200" Height="8" IsIndeterminate="True" Foreground="#22D3EE" Background="#1E293B" />
                    <TextBlock FontSize="15" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}" HorizontalAlignment="Center" Margin="0,16,0,0">
                        <Run Text="&#xE713;" FontFamily="{StaticResource FluentIcons}" /><Run Text=" Working on processes..." />
                    </TextBlock>
                    <TextBlock Text="Actions are briefly paused" FontSize="12" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Center" Margin="0,6,0,0" />
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Page>
