<Page x:Class="TidyWindow.App.Views.BootstrapPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="clr-namespace:TidyWindow.App.Converters"
    xmlns:controls="clr-namespace:TidyWindow.App.Views"
    xmlns:loaders="clr-namespace:TidyWindow.App.Controls.Loaders"
    mc:Ignorable="d"
    Title="Bootstrap"
    Background="Transparent">
    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>

        <Style x:Key="BootstrapAccentButtonStyle"
               TargetType="Button">
            <Setter Property="Background"
                    Value="#22C55E"/>
            <Setter Property="Foreground"
                    Value="#06111D"/>
            <Setter Property="BorderBrush"
                    Value="Transparent"/>
            <Setter Property="BorderThickness"
                    Value="0"/>
            <Setter Property="Padding"
                    Value="16,8"/>
            <Setter Property="Cursor"
                    Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Root"
                                Background="{TemplateBinding Background}"
                                CornerRadius="8"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver"
                                     Value="True">
                                <Setter TargetName="Root"
                                        Property="Background"
                                        Value="#16A34A"/>
                            </Trigger>
                            <Trigger Property="IsPressed"
                                     Value="True">
                                <Setter TargetName="Root"
                                        Property="Background"
                                        Value="#15803D"/>
                            </Trigger>
                            <Trigger Property="IsEnabled"
                                     Value="False">
                                <Setter TargetName="Root"
                                        Property="Background"
                                        Value="#14532D"/>
                                <Setter Property="Foreground"
                                        Value="#94A3B8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BootstrapDangerButtonStyle"
               TargetType="Button"
               BasedOn="{StaticResource BootstrapAccentButtonStyle}">
            <Setter Property="Background"
                    Value="#DC2626"/>
            <Setter Property="Foreground"
                    Value="#FEF2F2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Root"
                                Background="{TemplateBinding Background}"
                                CornerRadius="8"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver"
                                     Value="True">
                                <Setter TargetName="Root"
                                        Property="Background"
                                        Value="#B91C1C"/>
                            </Trigger>
                            <Trigger Property="IsPressed"
                                     Value="True">
                                <Setter TargetName="Root"
                                        Property="Background"
                                        Value="#991B1B"/>
                            </Trigger>
                            <Trigger Property="IsEnabled"
                                     Value="False">
                                <Setter TargetName="Root"
                                        Property="Background"
                                        Value="#7F1D1D"/>
                                <Setter Property="Foreground"
                                        Value="#FCA5A5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BootstrapCardStyle"
               TargetType="Border">
            <Setter Property="Background"
                    Value="#111827"/>
            <Setter Property="CornerRadius"
                    Value="12"/>
            <Setter Property="Padding"
                    Value="20"/>
            <Setter Property="BorderBrush"
                    Value="#1E293B"/>
            <Setter Property="BorderThickness"
                    Value="1"/>
        </Style>

        <SolidColorBrush x:Key="BootstrapMutedForeground"
                          Color="#64748B"/>

    </Page.Resources>

    <Grid>
        <ScrollViewer x:Name="RootScrollViewer"
                      Margin="32"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      CanContentScroll="False"
                      PanningMode="VerticalOnly">
            <Grid x:Name="PageGrid"
                  MinWidth="720">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

            <controls:PageTitleBar Title="Bootstrap workspace"
                                    Subtitle="{Binding Headline}"
                                    IconGlyph="ðŸ§°"
                                    Margin="0,0,0,20"/>

                <Grid x:Name="LayoutGrid"
                      Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="3*"
                                      MinWidth="360"/>
                    <ColumnDefinition Width="2*"
                                      MinWidth="320"/>
                </Grid.ColumnDefinitions>

                <StackPanel x:Name="LeftColumn"
                            Grid.Column="0"
                            Margin="0,0,24,0">
                    <Border Style="{StaticResource BootstrapCardStyle}"
                            Margin="0,0,0,24">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <StackPanel>
                                <TextBlock Text="Detection controls"
                                           FontSize="16"
                                           FontWeight="SemiBold"
                                           Foreground="#E2E8F0"/>
                                <TextBlock Text="Choose sources then run a deep profile of package managers installed on this machine."
                                           Margin="0,6,0,0"
                                           FontSize="12"
                                           Foreground="{StaticResource BootstrapMutedForeground}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>

                    <Grid Grid.Row="1"
                        Margin="0,18,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <WrapPanel Grid.Column="0"
                                           Orientation="Horizontal"
                                           HorizontalAlignment="Left">
                                    <CheckBox Style="{StaticResource App.CheckBoxStyle}"
                                              Content="Chocolatey"
                                              Margin="0,0,12,8"
                                              Foreground="#F8FAFC"
                                              IsChecked="{Binding IncludeChocolatey, Mode=TwoWay}"/>
                                    <CheckBox Style="{StaticResource App.CheckBoxStyle}"
                                              Content="Scoop"
                                              Margin="0,0,12,8"
                                              Foreground="#F8FAFC"
                                              IsChecked="{Binding IncludeScoop, Mode=TwoWay}"/>
                                </WrapPanel>
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            HorizontalAlignment="Right">
                                    <Button Content="Run detection"
                                            Command="{Binding DetectCommand}"
                                            MinWidth="148">
                                        <Button.Style>
                                            <Style TargetType="Button"
                                                   BasedOn="{StaticResource BootstrapAccentButtonStyle}">
                                                <Setter Property="FontWeight"
                                                        Value="SemiBold"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsBusy}"
                                                                 Value="True">
                                                        <Setter Property="IsEnabled"
                                                                Value="False"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </StackPanel>
                            </Grid>

                            <Grid Grid.Row="2"
                                  Margin="0,20,0,0">
                                <TextBlock VerticalAlignment="Center"
                                           Foreground="#CBD5F5"
                                           TextWrapping="Wrap"
                                           Text="{Binding Managers.Count, Mode=OneWay, StringFormat=Detected {0} package manager candidates.}"/>
                            </Grid>
                        </Grid>
                    </Border>

                    <Border Style="{StaticResource BootstrapCardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Orientation="Horizontal"
                                        VerticalAlignment="Center">
                                <TextBlock Text="Manager inventory"
                                           FontSize="16"
                                           FontWeight="SemiBold"
                                           Foreground="#E2E8F0"/>
                                <Border Margin="12,0,0,0"
                                        Padding="8,2"
                                        Background="#1E3A8A"
                                        CornerRadius="6">
                     <TextBlock Foreground="#C7D2FE"
                             FontSize="12">
                         <Run Text="{Binding Managers.Count, Mode=OneWay}"/>
                                        <Run Text=" tracked"/>
                                    </TextBlock>
                                </Border>
                            </StackPanel>

                            <ListView x:Name="ManagersList"
                                      Grid.Row="1"
                                      Margin="0,18,0,0"
                                      ItemsSource="{Binding Managers}"
                                      Background="Transparent"
                                      BorderThickness="0"
                                      Foreground="#F8FAFC"
                                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                                      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                      ScrollViewer.CanContentScroll="True"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling"
                                      VirtualizingStackPanel.ScrollUnit="Pixel">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment"
                                                Value="Stretch"/>
                                        <Setter Property="Padding"
                                                Value="0"/>
                                        <Setter Property="Margin"
                                                Value="0,4"/>
                                        <Setter Property="Background"
                                                Value="Transparent"/>
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.Style>
                                    <Style TargetType="ListView">
                                        <Setter Property="IsEnabled">
                                            <Setter.Value>
                                                <Binding Path="IsBusy"
                                                         Converter="{StaticResource InverseBooleanConverter}"/>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ListView.Style>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#0F172A"
                                                CornerRadius="10"
                                                Padding="16"
                                                BorderBrush="#1E293B"
                                                BorderThickness="1">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel>
                                                    <StackPanel Orientation="Horizontal"
                                                                VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Name}"
                                                                   FontSize="14"
                                                                   FontWeight="SemiBold"/>
                                                        <Border Margin="12,0,0,0"
                                                                Padding="8,2"
                                                                CornerRadius="10">
                                                            <Border.Style>
                                                                <Style TargetType="Border">
                                                                    <Setter Property="Background"
                                                                            Value="#F59E0B"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsInstalled}"
                                                                                     Value="True">
                                                                            <Setter Property="Background"
                                                                                    Value="#34D399"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Border.Style>
                                                            <TextBlock FontSize="12"
                                                                       FontWeight="SemiBold">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Text"
                                                                                Value="Missing"/>
                                                                        <Setter Property="Foreground"
                                                                                Value="#0F172A"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsInstalled}"
                                                                                         Value="True">
                                                                                <Setter Property="Text"
                                                                                        Value="Installed"/>
                                                                                <Setter Property="Foreground"
                                                                                        Value="#022C22"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Border>
                                                    </StackPanel>

                                                    <TextBlock Text="{Binding StatusMessage}"
                                                               Margin="0,12,0,0"
                                                               Foreground="#CBD5F5"
                                                               TextWrapping="Wrap"
                                                               LineStackingStrategy="BlockLineHeight"
                                                               LineHeight="18"/>
                                                </StackPanel>

                                                <StackPanel Grid.Column="1"
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Stretch">
                                                    <Button Content="{Binding ActionLabel}"
                                                            Command="{Binding DataContext.InstallCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                            CommandParameter="{Binding}"
                                                            MinWidth="132"
                                                            Visibility="{Binding ShowInstallAction, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                        <Button.Style>
                                                            <Style TargetType="Button"
                                                                   BasedOn="{StaticResource BootstrapAccentButtonStyle}">
                                                                <Setter Property="Margin"
                                                                        Value="0,0,0,8"/>
                                                                <Setter Property="Padding"
                                                                        Value="14,6"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsBusy}"
                                                                                 Value="True">
                                                                        <Setter Property="IsEnabled"
                                                                                Value="False"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding DataContext.IsBusy, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                                                 Value="True">
                                                                        <Setter Property="IsEnabled"
                                                                                Value="False"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                    <Button Content="{Binding UninstallLabel}"
                                                            Command="{Binding DataContext.UninstallCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                            CommandParameter="{Binding}"
                                                            MinWidth="132"
                                                            Margin="0,0,0,8"
                                                            Visibility="{Binding ShowUninstall, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                            IsEnabled="{Binding CanUninstall}">
                                                        <Button.Style>
                                                            <Style TargetType="Button"
                                                                   BasedOn="{StaticResource BootstrapDangerButtonStyle}">
                                                                <Setter Property="Padding"
                                                                        Value="14,6"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsBusy}"
                                                                                 Value="True">
                                                                        <Setter Property="IsEnabled"
                                                                                Value="False"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding DataContext.IsBusy, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                                                 Value="True">
                                                                        <Setter Property="IsEnabled"
                                                                                Value="False"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                    <TextBlock Text="{Binding ActionDescription}"
                                                               TextWrapping="Wrap"
                                                               Foreground="#EAB308"
                                                               Width="180"
                                                               Margin="0,0,0,8">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Visibility"
                                                                        Value="Collapsed"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding ShowActionDescription}"
                                                                                 Value="True">
                                                                        <Setter Property="Visibility"
                                                                                Value="Visible"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                    <TextBlock Text="{Binding LastOperationMessage}"
                                                               TextWrapping="Wrap"
                                                               Foreground="#94A3B8"
                                                               Width="180">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding LastOperationMessage}"
                                                                                 Value="">
                                                                        <Setter Property="Visibility"
                                                                                Value="Collapsed"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding LastOperationMessage}"
                                                                                 Value="{x:Null}">
                                                                        <Setter Property="Visibility"
                                                                                Value="Collapsed"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </Grid>
                    </Border>
                </StackPanel>

        <StackPanel x:Name="RightColumn"
                Grid.Column="1"
                Margin="16,0,0,0">
            <Border Style="{StaticResource BootstrapCardStyle}"
                Margin="0,0,0,24">
                        <StackPanel>
                            <TextBlock Text="PowerShell runtime"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="#E2E8F0"/>
                            <TextBlock Text="TidyWindow automations depend on PowerShell 7 or newer. Install it system-wide before running bootstrap tasks."
                                       Margin="0,8,0,0"
                                       TextWrapping="Wrap"
                                       Foreground="#94A3B8"
                                       FontSize="12"/>
                            <Border Margin="0,16,0,0"
                                    Background="#0B1626"
                                    CornerRadius="8"
                                    BorderBrush="#1E293B"
                                    BorderThickness="1"
                                    Padding="12">
                                <StackPanel>
                                    <TextBlock Text="Install with winget"
                                               FontSize="12"
                                               Foreground="#38BDF8"
                                               FontWeight="SemiBold"/>
                                    <TextBox Margin="0,6,0,0"
                                             Text="winget install --id Microsoft.PowerShell -e --accept-package-agreements --accept-source-agreements"
                                             IsReadOnly="True"
                                             BorderThickness="0"
                                             Style="{StaticResource App.TextBoxStyle}"
                                             FontFamily="Consolas"
                                             FontSize="12"
                                             TextWrapping="Wrap"/>
                                </StackPanel>
                            </Border>
                            <TextBlock Text="Already on PowerShell 7+? Youâ€™re good to goâ€”detection runs will use that runtime automatically."
                                       Margin="0,16,0,0"
                                       TextWrapping="Wrap"
                                       Foreground="#CBD5F5"
                                       FontSize="12"/>
                        </StackPanel>
                    </Border>
            <Border Style="{StaticResource BootstrapCardStyle}"
                Margin="0,0,0,24">
                        <StackPanel>
                            <TextBlock Text="Quick guidance"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="#E2E8F0"/>
                            <TextBlock Text="Make sure optional managers you care about are toggled on, then run detection. We'll queue suggested fixes automatically after each install run."
                                       Margin="0,8,0,0"
                                       TextWrapping="Wrap"
                                       Foreground="#94A3B8"
                                       FontSize="12"/>
                            <ItemsControl Margin="0,16,0,0">
                                <ItemsControl.Items>
                                    <TextBlock Text="Detection runs with the least privilege required. Accept elevated prompts if you expect admin tools."
                                               TextWrapping="Wrap"
                                               Foreground="#CBD5F5"
                                               Margin="0,0,0,12"/>
                                    <TextBlock Text="Use Install or repair to trigger a remediation. We automatically refresh detection when the run finishes."
                                               TextWrapping="Wrap"
                                               Foreground="#CBD5F5"
                                               Margin="0,0,0,12"/>
                                    <TextBlock Text="Head to the Install hub afterwards to queue curated bundles once your managers are healthy."
                                               TextWrapping="Wrap"
                                               Foreground="#CBD5F5"/>
                                </ItemsControl.Items>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource BootstrapCardStyle}">
                        <StackPanel>
                            <TextBlock Text="Status tips"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="#E2E8F0"/>
                            <StackPanel Margin="0,12,0,0">
                                <StackPanel Orientation="Horizontal"
                                            Margin="0,0,0,8">
                                    <Ellipse Width="10"
                                             Height="10"
                                             Fill="#34D399"
                                             VerticalAlignment="Center"/>
                                    <TextBlock Text="Installed managers are ready for bundle orchestration."
                                               Margin="12,0,0,0"
                                               Foreground="#CBD5F5"
                                               TextWrapping="Wrap"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal"
                                            Margin="0,0,0,8">
                                    <Ellipse Width="10"
                                             Height="10"
                                             Fill="#F59E0B"
                                             VerticalAlignment="Center"/>
                                    <TextBlock Text="Missing managers can usually be fixed with a single repair run."
                                               Margin="12,0,0,0"
                                               Foreground="#CBD5F5"
                                               TextWrapping="Wrap"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse Width="10"
                                             Height="10"
                                             Fill="#F87171"
                                             VerticalAlignment="Center"/>
                                    <TextBlock Text="Errors stick around with details so you can review the transcript in Activity log."
                                               Margin="12,0,0,0"
                                               Foreground="#CBD5F5"
                                               TextWrapping="Wrap"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Grid>
        </Grid>
        </ScrollViewer>

        <loaders:BootstrapInstallLoader Panel.ZIndex="6"
                                        IsActive="{Binding IsInstalling}"
                                        HorizontalAlignment="Stretch"
                                        VerticalAlignment="Stretch"/>
        <loaders:BootstrapUninstallLoader Panel.ZIndex="7"
                                          IsActive="{Binding IsUninstalling}"
                                          HorizontalAlignment="Stretch"
                                          VerticalAlignment="Stretch"/>
        <loaders:BootstrapUpdateLoader Panel.ZIndex="8"
                                       IsActive="{Binding IsUpdating}"
                                       HorizontalAlignment="Stretch"
                                       VerticalAlignment="Stretch"/>
    </Grid>
</Page>
