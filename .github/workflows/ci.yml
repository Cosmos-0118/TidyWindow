name: CI

on:
    workflow_dispatch:
        inputs:
            reason:
                description: "Optional note when manually triggering CI"
                required: false
                type: string

jobs:
    build:
        runs-on: windows-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 8.0.x

            - name: Restore
              run: dotnet restore src/TidyWindow.sln

            - name: Build
              run: dotnet build src/TidyWindow.sln --configuration Release --no-restore

            - name: Test
              run: dotnet test src/TidyWindow.sln --configuration Release --no-build

            - name: Publish packaging snapshot
              run: dotnet publish src/TidyWindow.App/TidyWindow.App.csproj --configuration Release --runtime win-x64 --self-contained false --no-restore

            - name: Verify packaged automation assets
              shell: pwsh
              run: |
                  $publishDir = "src/TidyWindow.App/bin/Release/net8.0-windows/win-x64/publish"
                  if (-not (Test-Path $publishDir)) {
                    throw "Publish directory not found: $publishDir"
                  }
                  $requiredPaths = @(
                    "automation/essentials/disk-checkup-and-fix.ps1",
                    "automation/scripts/deep-scan.ps1",
                    "automation/modules/TidyWindow.Automation.psm1",
                    "data/catalog/bundles.yml",
                    "data/catalog/packages/core.yml"
                  )
                  foreach ($relative in $requiredPaths) {
                    $fullPath = Join-Path $publishDir $relative
                    if (-not (Test-Path $fullPath)) {
                      throw "Missing packaged asset: $relative"
                    }
                  }

